–°–ò–°–¢–ï–ú–ê –ü–ê–ü–û–ö –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ù–ê–°–¢–†–û–ï–ö –¢–ê–ë–õ–ò–¶
==============================================

üìÅ –û–ë–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´
============================

–°–∏—Å—Ç–µ–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–∞–±–ª–∏—Ü –≤ AI Bot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:

1. –í–†–ï–ú–ï–ù–ù–û–ï –•–†–ê–ù–ï–ù–ò–ï (–í –ø–∞–º—è—Ç–∏)
2. –õ–û–ö–ê–õ–¨–ù–û–ï –§–ê–ô–õ–û–í–û–ï –•–†–ê–ù–ï–ù–ò–ï
3. –û–ë–õ–ê–ß–ù–û–ï –•–†–ê–ù–ï–ù–ò–ï (Firestore)
4. –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò

üèóÔ∏è –°–¢–†–£–ö–¢–£–†–ê –ü–ê–ü–û–ö –ò –§–ê–ô–õ–û–í
============================

–ö–û–†–ù–ï–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê:
```
AI Bot/
‚îú‚îÄ‚îÄ config/                          # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ table_config.py             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü
‚îÇ   ‚îú‚îÄ‚îÄ settings.py                 # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ locales/                    # –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ ru.py                   # –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
‚îÇ       ‚îú‚îÄ‚îÄ en.py                   # –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫
‚îÇ       ‚îî‚îÄ‚îÄ id.py                   # –ò–Ω–¥–æ–Ω–µ–∑–∏–π—Å–∫–∏–π —è–∑—ã–∫
‚îú‚îÄ‚îÄ data/                           # –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ ingredient_matching_*.json  # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ table_settings_*.json       # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–±–ª–∏—Ü (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
‚îú‚îÄ‚îÄ handlers/                       # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ table_settings_handler.py  # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–∞–±–ª–∏—Ü
‚îÇ   ‚îî‚îÄ‚îÄ callback_handlers.py       # –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îú‚îÄ‚îÄ services/                       # –°–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ google_sheets_manager.py   # –ú–µ–Ω–µ–¥–∂–µ—Ä Google Sheets
‚îÇ   ‚îî‚îÄ‚îÄ ingredients_manager.py     # –ú–µ–Ω–µ–¥–∂–µ—Ä –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
‚îî‚îÄ‚îÄ utils/                         # –£—Ç–∏–ª–∏—Ç—ã
    ‚îú‚îÄ‚îÄ table_manager.py           # –ú–µ–Ω–µ–¥–∂–µ—Ä —Ç–∞–±–ª–∏—Ü
    ‚îî‚îÄ‚îÄ ingredient_storage.py      # –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
```

üìä –£–†–û–í–ù–ò –•–†–ê–ù–ï–ù–ò–Ø –ù–ê–°–¢–†–û–ï–ö
===========================

1. –£–†–û–í–ï–ù–¨ 1: –í–†–ï–ú–ï–ù–ù–û–ï –•–†–ê–ù–ï–ù–ò–ï (–í –ø–∞–º—è—Ç–∏)
-------------------------------------------
–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: config/table_config.py
–ö–ª–∞—Å—Å: TableConfigManager

```python
class TableConfigManager:
    def __init__(self):
        self._configs: Dict[str, TableConfig] = {}                    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        self._user_customizations: Dict[int, Dict[str, TableConfig]] = {}  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```

–°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•:
- _configs: –°–ª–æ–≤–∞—Ä—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
  - –ö–ª—é—á: "table_type_device_type" (–Ω–∞–ø—Ä–∏–º–µ—Ä, "ingredient_matching_mobile")
  - –ó–Ω–∞—á–µ–Ω–∏–µ: TableConfig –æ–±—ä–µ–∫—Ç
- _user_customizations: –°–ª–æ–≤–∞—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
  - –ö–ª—é—á: user_id (int)
  - –ó–Ω–∞—á–µ–Ω–∏–µ: –°–ª–æ–≤–∞—Ä—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü–†–ò–ú–ï–† –°–¢–†–£–ö–¢–£–†–´:
```python
_user_customizations = {
    123456789: {  # user_id
        "ingredient_matching_mobile": TableConfig(...),
        "google_sheets_preview_desktop": TableConfig(...)
    },
    987654321: {  # user_id
        "receipt_preview_mobile": TableConfig(...)
    }
}
```

2. –£–†–û–í–ï–ù–¨ 2: –õ–û–ö–ê–õ–¨–ù–û–ï –§–ê–ô–õ–û–í–û–ï –•–†–ê–ù–ï–ù–ò–ï
-----------------------------------------
–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: data/ –ø–∞–ø–∫–∞
–§–æ—Ä–º–∞—Ç: JSON —Ñ–∞–π–ª—ã

–¢–ï–ö–£–©–ê–Ø –°–¢–†–£–ö–¢–£–†–ê:
```
data/
‚îú‚îÄ‚îÄ ingredient_matching_261617302_254eed3d.json
‚îú‚îÄ‚îÄ ingredient_matching_261617302_416c68c5.json
‚îú‚îÄ‚îÄ ingredient_matching_261617302_7251808e.json
‚îî‚îÄ‚îÄ ingredient_matching_261617302_be09726d.json
```

–ü–õ–ê–ù–ò–†–£–ï–ú–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –î–õ–Ø –ù–ê–°–¢–†–û–ï–ö –¢–ê–ë–õ–ò–¶:
```
data/
‚îú‚îÄ‚îÄ table_settings/
‚îÇ   ‚îú‚îÄ‚îÄ user_123456789_settings.json
‚îÇ   ‚îú‚îÄ‚îÄ user_987654321_settings.json
‚îÇ   ‚îî‚îÄ‚îÄ global_settings.json
‚îî‚îÄ‚îÄ ingredient_matching/
    ‚îú‚îÄ‚îÄ ingredient_matching_261617302_254eed3d.json
    ‚îî‚îÄ‚îÄ ...
```

–§–û–†–ú–ê–¢ –§–ê–ô–õ–ê –ù–ê–°–¢–†–û–ï–ö –¢–ê–ë–õ–ò–¶:
```json
{
    "user_id": 123456789,
    "device_type": "mobile",
    "table_configs": {
        "ingredient_matching_mobile": {
            "table_type": "ingredient_matching",
            "device_type": "mobile",
            "columns": [...],
            "style": {...},
            "title": "–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤",
            "max_items_per_page": 8
        }
    },
    "last_updated": "2024-01-15T10:30:00Z"
}
```

3. –£–†–û–í–ï–ù–¨ 3: –û–ë–õ–ê–ß–ù–û–ï –•–†–ê–ù–ï–ù–ò–ï (Firestore)
--------------------------------------------
–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: Google Cloud Firestore
–°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ö–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã

–¢–ï–ö–£–©–ê–Ø –°–¢–†–£–ö–¢–£–†–ê FIRESTORE:
```
users/{telegram_user_id}/
‚îú‚îÄ‚îÄ google_sheets/
‚îÇ   ‚îî‚îÄ‚îÄ {sheet_doc_id}/
‚îÇ       ‚îú‚îÄ‚îÄ sheet_url (string)
‚îÇ       ‚îú‚îÄ‚îÄ sheet_id (string)
‚îÇ       ‚îú‚îÄ‚îÄ friendly_name (string)
‚îÇ       ‚îú‚îÄ‚îÄ is_default (boolean)
‚îÇ       ‚îú‚îÄ‚îÄ created_at (timestamp)
‚îÇ       ‚îú‚îÄ‚îÄ data_start_row (integer)
‚îÇ       ‚îî‚îÄ‚îÄ column_mapping (map)
‚îî‚îÄ‚îÄ ingredients/
    ‚îî‚îÄ‚îÄ personal_ingredients (array)
```

–ü–õ–ê–ù–ò–†–£–ï–ú–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –î–õ–Ø –ù–ê–°–¢–†–û–ï–ö –¢–ê–ë–õ–ò–¶:
```
users/{telegram_user_id}/
‚îú‚îÄ‚îÄ table_settings/
‚îÇ   ‚îú‚îÄ‚îÄ device_type (string)
‚îÇ   ‚îú‚îÄ‚îÄ global_preferences (map)
‚îÇ   ‚îî‚îÄ‚îÄ table_configs/
‚îÇ       ‚îú‚îÄ‚îÄ ingredient_matching/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ mobile (map)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ desktop (map)
‚îÇ       ‚îú‚îÄ‚îÄ google_sheets_preview/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ mobile (map)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ desktop (map)
‚îÇ       ‚îî‚îÄ‚îÄ receipt_preview/
‚îÇ           ‚îú‚îÄ‚îÄ mobile (map)
‚îÇ           ‚îî‚îÄ‚îÄ desktop (map)
‚îú‚îÄ‚îÄ google_sheets/
‚îî‚îÄ‚îÄ ingredients/
```

4. –£–†–û–í–ï–ù–¨ 4: –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
--------------------------------------
–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: config/table_config.py
–ú–µ—Ç–æ–¥: _load_default_configs()

–°–¢–†–£–ö–¢–£–†–ê –°–¢–ê–ù–î–ê–†–¢–ù–´–• –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ô:
```python
# –ú–æ–±–∏–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
"ingredient_matching_mobile"
"google_sheets_matching_mobile" 
"receipt_preview_mobile"
"google_sheets_preview_mobile"
"next_items_mobile"

# –î–µ—Å–∫—Ç–æ–ø–Ω—ã–µ –≤–µ—Ä—Å–∏–∏
"ingredient_matching_desktop"
"google_sheets_matching_desktop"
"receipt_preview_desktop" 
"google_sheets_preview_desktop"
"next_items_desktop"
```

üîß –ú–ï–ù–ï–î–ñ–ï–†–´ –ò –°–ï–†–í–ò–°–´
======================

1. TableConfigManager (config/table_config.py)
-----------------------------------------------
–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨:
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –≤ –ø–∞–º—è—Ç–∏
- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ > —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ)

–û–°–ù–û–í–ù–´–ï –ú–ï–¢–û–î–´:
```python
def get_config(table_type, device_type, user_id=None) -> TableConfig
def set_user_config(user_id, table_type, device_type, config)
def reset_user_config(user_id, table_type, device_type)
def get_available_configs(user_id=None) -> Dict[str, TableConfig]
```

2. TableManager (utils/table_manager.py)
----------------------------------------
–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨:
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

–û–°–ù–û–í–ù–´–ï –ú–ï–¢–û–î–´:
```python
def get_user_table_settings(user_id) -> Dict[str, Any]
def update_user_table_settings(user_id, table_type, device_type, config)
def reset_user_table_settings(user_id, table_type, device_type)
```

3. TableSettingsHandler (handlers/table_settings_handler.py)
------------------------------------------------------------
–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨:
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫

–û–°–ù–û–í–ù–´–ï –ú–ï–¢–û–î–´:
```python
async def show_table_settings_menu(update, context) -> int
async def show_table_type_settings(update, context, table_type) -> int
async def update_table_setting(update, context, table_type, setting) -> int
```

4. IngredientStorage (utils/ingredient_storage.py)
--------------------------------------------------
–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨:
- –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ñ–∞–π–ª–∞–º–∏
- –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤

–°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–û–í:
```
data/
‚îî‚îÄ‚îÄ ingredient_matching_{user_id}_{receipt_hash}.json
```

üìù –ü–†–ò–û–†–ò–¢–ï–¢–´ –ó–ê–ì–†–£–ó–ö–ò –ù–ê–°–¢–†–û–ï–ö
===============================

1. –ü–ï–†–í–´–ô –ü–†–ò–û–†–ò–¢–ï–¢: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ø–∞–º—è—Ç–∏
   - –ò—Å—Ç–æ—á–Ω–∏–∫: _user_customizations[user_id]
   - –ö–ª—é—á: f"{table_type.value}_{device_type.value}"

2. –í–¢–û–†–û–ô –ü–†–ò–û–†–ò–¢–ï–¢: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
   - –ò—Å—Ç–æ—á–Ω–∏–∫: _configs
   - –ö–ª—é—á: f"{table_type.value}_{device_type.value}"

3. –¢–†–ï–¢–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢: Fallback –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–Ω—É—é –≤–µ—Ä—Å–∏—é
   - –ò—Å—Ç–æ—á–Ω–∏–∫: _configs
   - –ö–ª—é—á: f"{table_type.value}_desktop"

4. –ß–ï–¢–í–ï–†–¢–´–ô –ü–†–ò–û–†–ò–¢–ï–¢: –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
   - –ò—Å—Ç–æ—á–Ω–∏–∫: _create_fallback_config()

üîÑ –ü–†–û–¶–ï–°–° –°–û–•–†–ê–ù–ï–ù–ò–Ø –ù–ê–°–¢–†–û–ï–ö
==============================

1. –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ò–ó–ú–ï–ù–Ø–ï–¢ –ù–ê–°–¢–†–û–ô–ö–ò
   - –ß–µ—Ä–µ–∑ TableSettingsHandler
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

2. –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ü–ê–ú–Ø–¢–ò
   - TableConfigManager.set_user_config()
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ _user_customizations

3. –°–û–•–†–ê–ù–ï–ù–ò–ï –í –§–ê–ô–õ (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
   - –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ data/table_settings/
   - –§–æ—Ä–º–∞—Ç: JSON
   - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å

4. –°–û–•–†–ê–ù–ï–ù–ò–ï –í FIRESTORE (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: users/{user_id}/table_settings/
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º

üîÑ –ü–†–û–¶–ï–°–° –ó–ê–ì–†–£–ó–ö–ò –ù–ê–°–¢–†–û–ï–ö
============================

1. –ó–ê–ü–†–û–° –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
   - TableManager.get_user_table_settings(user_id)
   - TableConfigManager.get_config(table_type, device_type, user_id)

2. –ü–†–û–í–ï–†–ö–ê –ü–ê–ú–Ø–¢–ò
   - –ü–æ–∏—Å–∫ –≤ _user_customizations[user_id]
   - –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ - –≤–æ–∑–≤—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

3. –ó–ê–ì–†–£–ó–ö–ê –ò–ó –§–ê–ô–õ–ê (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
   - –ß—Ç–µ–Ω–∏–µ –∏–∑ data/table_settings/user_{user_id}_settings.json
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ _user_customizations

4. –ó–ê–ì–†–£–ó–ö–ê –ò–ó FIRESTORE (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
   - –ó–∞–ø—Ä–æ—Å –∫ users/{user_id}/table_settings/
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ª–æ–∫–∞–ª—å–Ω—ã–º —Ñ–∞–π–ª–æ–º

5. FALLBACK –ù–ê –°–¢–ê–ù–î–ê–†–¢–ù–´–ï
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
   - –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

üìÅ –ü–†–ï–î–õ–ê–ì–ê–ï–ú–ê–Ø –ù–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ü–ê–ü–û–ö
======================================

–ö–û–†–ù–ï–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê:
```
AI Bot/
‚îú‚îÄ‚îÄ config/                          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ table_config.py             # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞–±–ª–∏—Ü
‚îÇ   ‚îú‚îÄ‚îÄ settings.py                 # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ locales/                    # –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ data/                           # –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ table_settings/             # –ù–û–í–ê–Ø –ü–ê–ü–ö–ê
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/                  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_123456789.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user_987654321.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ global/                 # –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ default_configs.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cache/                  # –ö—ç—à –Ω–∞—Å—Ç—Ä–æ–µ–∫
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ active_configs.json
‚îÇ   ‚îú‚îÄ‚îÄ ingredient_matching/        # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user_123456789/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ receipt_abc123.json
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ receipt_def456.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user_987654321/
‚îÇ   ‚îî‚îÄ‚îÄ temp/                       # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
‚îÇ       ‚îî‚îÄ‚îÄ uploads/
‚îú‚îÄ‚îÄ handlers/                       # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
‚îú‚îÄ‚îÄ services/                       # –°–µ—Ä–≤–∏—Å—ã
‚îî‚îÄ‚îÄ utils/                         # –£—Ç–∏–ª–∏—Ç—ã
```

–°–¢–†–£–ö–¢–£–†–ê –§–ê–ô–õ–ê –ù–ê–°–¢–†–û–ï–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
```json
{
    "user_id": 123456789,
    "username": "user123",
    "device_type": "mobile",
    "language": "ru",
    "created_at": "2024-01-15T10:30:00Z",
    "last_updated": "2024-01-15T15:45:00Z",
    "table_configs": {
        "ingredient_matching_mobile": {
            "table_type": "ingredient_matching",
            "device_type": "mobile",
            "columns": [...],
            "style": {
                "max_name_length": 15,
                "compact_mode": true,
                "show_separators": true,
                "use_emojis": true,
                "show_row_numbers": true,
                "header_style": "bold"
            },
            "title": "–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤",
            "max_items_per_page": 8,
            "show_pagination": true,
            "custom_formatter": null
        }
    },
    "global_preferences": {
        "auto_detect_device": true,
        "default_device_type": "mobile",
        "theme": "default"
    }
}
```

üîß –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ù–û–í–û–ô –°–ò–°–¢–ï–ú–´
============================

1. –°–û–ó–î–ê–ù–ò–ï –ù–û–í–´–• –ö–õ–ê–°–°–û–í
-------------------------

TableSettingsStorage (utils/table_settings_storage.py):
```python
class TableSettingsStorage:
    def __init__(self, storage_dir="data/table_settings"):
        self.storage_dir = storage_dir
        self.users_dir = os.path.join(storage_dir, "users")
        self.global_dir = os.path.join(storage_dir, "global")
        self.cache_dir = os.path.join(storage_dir, "cache")
    
    async def save_user_settings(self, user_id, settings):
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        pass
    
    async def load_user_settings(self, user_id):
        # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        pass
    
    async def sync_with_firestore(self, user_id):
        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Firestore
        pass
```

FirestoreTableSettings (services/firestore_table_settings.py):
```python
class FirestoreTableSettings:
    def __init__(self, db):
        self.db = db
    
    async def save_user_table_settings(self, user_id, settings):
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firestore
        pass
    
    async def load_user_table_settings(self, user_id):
        # –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Firestore
        pass
```

2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –ö–õ–ê–°–°–û–í
----------------------------------

TableConfigManager:
```python
def __init__(self):
    self._configs: Dict[str, TableConfig] = {}
    self._user_customizations: Dict[int, Dict[str, TableConfig]] = {}
    self.storage = TableSettingsStorage()  # –ù–û–í–û–ï
    self.firestore = FirestoreTableSettings()  # –ù–û–í–û–ï
    self._load_default_configs()
    self._load_user_settings_from_storage()  # –ù–û–í–û–ï

async def save_user_config(self, user_id, table_type, device_type, config):
    # –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
    self._user_customizations[user_id][config_key] = config
    # –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª –∏ Firestore
    await self.storage.save_user_settings(user_id, self._user_customizations[user_id])
    await self.firestore.save_user_table_settings(user_id, self._user_customizations[user_id])
```

3. –ú–ò–ì–†–ê–¶–ò–Ø –°–£–©–ï–°–¢–í–£–Æ–©–ò–• –î–ê–ù–ù–´–•
-------------------------------

Migration script (scripts/migrate_table_settings.py):
```python
async def migrate_existing_settings():
    # –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –ø–∞–º—è—Ç–∏ –≤ —Ñ–∞–π–ª—ã
    # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫
    # –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö –≤ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    pass
```

üéØ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –ù–û–í–û–ô –°–ò–°–¢–ï–ú–´
=============================

1. –ü–ï–†–°–ò–°–¢–ï–ù–¢–ù–û–°–¢–¨
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ–±–ª–∞–∫–µ

2. –ú–ê–°–®–¢–ê–ë–ò–†–£–ï–ú–û–°–¢–¨
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

3. –ì–ò–ë–ö–û–°–¢–¨
- –õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Ç–∞–±–ª–∏—Ü
- –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –ø–æ–¥ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

4. –ù–ê–î–ï–ñ–ù–û–°–¢–¨
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

5. –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨
- –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∫—ç—à–∞
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î

üîç –ú–û–ù–ò–¢–û–†–ò–ù–ì –ò –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
============================

1. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –û–ü–ï–†–ê–¶–ò–ô
```python
import logging

logger = logging.getLogger('table_settings')

async def save_user_settings(self, user_id, settings):
    logger.info(f"Saving table settings for user {user_id}")
    try:
        # –õ–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        logger.info(f"Successfully saved settings for user {user_id}")
    except Exception as e:
        logger.error(f"Failed to save settings for user {user_id}: {e}")
```

2. –ú–ï–¢–†–ò–ö–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –ß–∞—Å—Ç–æ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π

3. –û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–•
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
- –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π

–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï
==========

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–∞–ø–æ–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–∞–±–ª–∏—Ü –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

‚úÖ –ú–ù–û–ì–û–£–†–û–í–ù–ï–í–û–ï –•–†–ê–ù–ï–ù–ò–ï - –ø–∞–º—è—Ç—å, —Ñ–∞–π–ª—ã, –æ–±–ª–∞–∫–æ
‚úÖ –ü–ï–†–°–ò–°–¢–ï–ù–¢–ù–û–°–¢–¨ - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏  
‚úÖ –ú–ê–°–®–¢–ê–ë–ò–†–£–ï–ú–û–°–¢–¨ - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚úÖ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Æ - –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏
‚úÖ –ù–ê–î–ï–ñ–ù–û–°–¢–¨ - —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
‚úÖ –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨ - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –≤ Telegram-–±–æ—Ç–µ.
