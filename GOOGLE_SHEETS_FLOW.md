# 🌐 Схема ветки загрузки в Google Таблицы

## 📊 Основной поток

```
┌─────────────────────────────────────────────────────────┐
│                📊 ЗАГРУЗИТЬ В GOOGLE ТАБЛИЦЫ            │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│              🔍 ПРОВЕРКА ДОСТУПНОСТИ                    │
│                   Google Sheets API                     │
└─────────────────────────────────────────────────────────┘
                            │
                    ┌───────┴───────┐
                    │               │
                    ▼               ▼
        ┌─────────────────┐ ┌─────────────────┐
        │   ❌ НЕДОСТУПЕН │ │   ✅ ДОСТУПЕН   │
        │   Ошибка сервиса│ │   Продолжить    │
        └─────────────────┘ └─────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│            📋 ЗАГРУЗКА СПРАВОЧНИКА ИНГРЕДИЕНТОВ         │
│                   Google Sheets                         │
└─────────────────────────────────────────────────────────┘
                            │
                    ┌───────┴───────┐
                    │               │
                    ▼               ▼
        ┌─────────────────┐ ┌─────────────────┐
        │   ❌ ОШИБКА     │ │   ✅ УСПЕШНО    │
        │   Не удалось    │ │   Справочник    │
        │   загрузить     │ │   загружен      │
        └─────────────────┘ └─────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│              🔄 СОПОСТАВЛЕНИЕ ИНГРЕДИЕНТОВ              │
│                   с Google Sheets                       │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│        📊 СТРАНИЦА СОПОСТАВЛЕНИЯ С ИНГРЕДИЕНТАМИ        │
│                   Google Таблиц                         │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │  №  │ Наименование  │ Google Таблицы │ Статус  │   │
│  ├─────────────────────────────────────────────────┤   │
│  │  1  │ Товар 1      │ Ингредиент 1   │   🟢    │   │
│  │  2  │ Товар 2      │ Ингредиент 2   │   🟡    │   │
│  │  3  │ Товар 3      │ —              │   🔴    │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  [✏️ Редактировать] [👁️ Предпросмотр] [◀️ Назад]      │
└─────────────────────────────────────────────────────────┘
```

## 🔀 Ветки навигации

### 1️⃣ Ветка редактирования
```
✏️ РЕДАКТИРОВАТЬ СОПОСТАВЛЕНИЕ
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│        📝 РЕДАКТОР СОПОСТАВЛЕНИЯ ДЛЯ GOOGLE ТАБЛИЦ      │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │  №  │ Наименование  │ Google Таблицы │ Статус  │   │
│  ├─────────────────────────────────────────────────┤   │
│  │  1  │ Товар 1      │ Ингредиент 1   │   🟢    │   │
│  │  2  │ Товар 2      │ Ингредиент 2   │   🟡    │   │
│  │  3  │ Товар 3      │ —              │   🔴    │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  [🟡 Товар 2] [🔴 Товар 3]                            │
│  [🔍 Выбрать позицию] [✅ Применить] [◀️ Назад]        │
└─────────────────────────────────────────────────────────┘
                            │
                    ┌───────┴───────┐
                    │               │
                    ▼               ▼
        ┌─────────────────┐ ┌─────────────────┐
        │   🔍 ВЫБРАТЬ    │ │   ✅ ПРИМЕНИТЬ  │
        │   ПОЗИЦИЮ       │ │   ИЗМЕНЕНИЯ     │
        │                 │ │                 │
        │   ┌─────────┐   │ │   ┌─────────┐   │
        │   │ Выбор   │   │ │   │Возврат к│   │
        │   │ строки  │   │ │   │предпрос-│   │
        │   └─────────┘   │ │   │мотру    │   │
        │         │       │ │   └─────────┘   │
        │         ▼       │ │         │       │
        │   ┌─────────┐   │ │         ▼       │
        │   │ 🔍 Поиск│   │ │   ┌─────────┐   │
        │   │ в спра- │   │ │   │👁️ ПРЕД- │   │
        │   │ вочнике │   │ │   │ПРОСМОТР │   │
        │   └─────────┘   │ │   └─────────┘   │
        └─────────────────┘ └─────────────────┘
```

### 2️⃣ Ветка предпросмотра
```
👁️ ПРЕДПРОСМОТР
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│              👁️ ПРЕДПРОСМОТР ЗАГРУЗКИ                  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Дата      │ Объем    │ Цена      │ Продукт     │   │
│  ├─────────────────────────────────────────────────┤   │
│  │ 15.01.2024│ 2.50 kg  │ 1,500 Rp  │ Ингредиент 1│   │
│  │ 15.01.2024│ 1.00 kg  │ 2,000 Rp  │ Ингредиент 2│   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  [✅ Загрузить в Google Таблицы] [◀️ Назад]            │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│              ✅ ВЫПОЛНЕНИЕ ЗАГРУЗКИ                     │
│                   в Google Sheets                       │
└─────────────────────────────────────────────────────────┘
                            │
                    ┌───────┴───────┐
                    │               │
                    ▼               ▼
        ┌─────────────────┐ ┌─────────────────┐
        │   ✅ УСПЕШНО    │ │   ❌ ОШИБКА     │
        │   Загрузка      │ │   Загрузка      │
        │   завершена     │ │   не удалась    │
        │                 │ │                 │
        │   ┌─────────┐   │ │   ┌─────────┐   │
        │   │↩️ Отменить│   │ │   │🔄 Попро-│   │
        │   │📄 Файл  │   │ │   │бовать   │   │
        │   │◀️ Назад  │   │ │   │снова    │   │
        │   └─────────┘   │ │   └─────────┘   │
        └─────────────────┘ └─────────────────┘
```

## 🔄 Синхронизация данных

### Обмен данными между страницами
```
┌─────────────────────────────────────────────────────────┐
│                matching_result                          │
│            (context.user_data)                          │
└─────────────────────────────────────────────────────────┘
                            │
                    ┌───────┴───────┐
                    │               │
                    ▼               ▼
        ┌─────────────────┐ ┌─────────────────┐
        │   📊 СТРАНИЦА   │ │   📝 РЕДАКТОР   │
        │   СОПОСТАВЛЕНИЯ│ │   СОПОСТАВЛЕНИЯ │
        │                 │ │                 │
        │   Показывает    │ │   Редактирует   │
        │   таблицу       │ │   таблицу       │
        │                 │ │                 │
        │   ┌─────────┐   │ │   ┌─────────┐   │
        │   │_format_ │   │ │   │_format_ │   │
        │   │google_  │   │ │   │google_  │   │
        │   │sheets_  │   │ │   │sheets_  │   │
        │   │matching_│   │ │   │matching_│   │
        │   │table()  │   │ │   │table()  │   │
        │   └─────────┘   │ │   └─────────┘   │
        └─────────────────┘ └─────────────────┘
                            │
                            ▼
                    ┌─────────────────┐
                    │   🔄 ИЗМЕНЕНИЯ   │
                    │   АВТОМАТИЧЕСКИ │
                    │   ОТРАЖАЮТСЯ    │
                    └─────────────────┘
```

## 🎯 Ключевые особенности

### ✅ Синхронизация
- Обе страницы показывают одинаковую таблицу
- Изменения в редакторе автоматически отражаются на странице сопоставления
- Данные сохраняются в `matching_result`

### 🔍 Поиск и редактирование
- Поиск ингредиентов в справочнике Google Sheets
- Ручной ввод названий ингредиентов
- Выбор из результатов поиска

### ❌ Обработка ошибок
- Проверка доступности Google Sheets API
- Проверка загрузки справочника
- Обработка ошибок загрузки данных
- Возможность повторной попытки

### 🧭 Навигация
- Кнопки "Назад" для возврата к предыдущим страницам
- Кнопки "Применить изменения" для сохранения
- Кнопки "Попробовать снова" при ошибках
