# Keep-Alive –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è Cloud Run

## –û–ø–∏—Å–∞–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º keep-alive –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "—Ö–æ–ª–æ–¥–Ω—ã–π —Å—Ç–∞—Ä—Ç" –∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ Google Cloud Run –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞, –Ω–µ –∏–∑–º–µ–Ω—è—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `min-instances`.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL**: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π –≤–Ω–µ—à–Ω–∏–π URL –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `SERVICE_URL`
2. **–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞**: –°–æ–∑–¥–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ `keep_alive_ping()`, –∫–æ—Ç–æ—Ä–∞—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π `/health` —ç–Ω–¥–ø–æ–∏–Ω—Ç
3. **–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–∏–Ω–≥–æ–≤**: –°–æ–∑–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç `/health` –¥–ª—è –ø—Ä–∏–µ–º–∞ keep-alive –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è FastAPI lifespan –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–¥–∞—á–∏

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è SERVICE_URL

```bash
# –í Cloud Run –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è Google
SERVICE_URL=https://your-service-name-hash-uc.a.run.app
```

### 2. –§—É–Ω–∫—Ü–∏—è keep_alive_ping()

```python
async def keep_alive_ping(service_url: str) -> None:
    """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ keep-alive –ø–∏–Ω–≥–æ–≤ –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π URL"""
    while True:
        try:
            await asyncio.sleep(300)  # 5 –º–∏–Ω—É—Ç
            async with httpx.AsyncClient(timeout=30.0) as client:
                response = await client.get(f"{service_url}/health")
                if response.status_code == 200:
                    print("üíì Keep-alive ping sent successfully.")
        except Exception as e:
            print(f"‚ùå Keep-alive ping failed: {e}")
```

### 3. –≠–Ω–¥–ø–æ–∏–Ω—Ç /health

```python
@app.get("/health")
async def health_ping():
    """Health ping endpoint –¥–ª—è keep-alive –∑–∞–ø—Ä–æ—Å–æ–≤"""
    return {"status": "ok"}
```

### 4. Lifespan —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    service_url = os.getenv("SERVICE_URL")
    if service_url:
        keep_alive_task_obj = asyncio.create_task(keep_alive_ping(service_url))
    
    yield
    
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏
    if keep_alive_task_obj and not keep_alive_task_obj.done():
        keep_alive_task_obj.cancel()
```

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `SERVICE_URL`
   - –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ keep-alive
   - –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º), keep-alive –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è

2. **–í–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã**:
   - –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è GET-–∑–∞–ø—Ä–æ—Å –Ω–∞ `{SERVICE_URL}/health`
   - –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ—Ç–≤–µ—Ç–µ (200 OK) –≤—ã–≤–æ–¥–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –Ω–æ —Ü–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è

3. **–ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**:
   - Keep-alive –∑–∞–¥–∞—á–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è
   - –í—ã–≤–æ–¥–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ –∑–∞–¥–∞—á–∏

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –ó–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ **–£—Å–ª–æ–≤–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è**: –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Cloud Run (–∫–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω SERVICE_URL)
- ‚úÖ **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –æ—à–∏–±–∫–∞–º**: –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö
- ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**: –ü—Ä–æ—Å—Ç—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç—ã

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ keep-alive

```
üíì Keep-alive ping –∑–∞–ø—É—â–µ–Ω –¥–ª—è https://your-service-name-hash-uc.a.run.app
üíì Keep-alive ping sent successfully.
üíì Keep-alive ping sent successfully.
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

–ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å keep-alive —á–µ—Ä–µ–∑ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:

- `GET /` - –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- `GET /health` - –ø—Ä–æ—Å—Ç–æ–π health check
- `GET /keepalive` - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ keep-alive

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –î–ª—è Cloud Run

–ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `SERVICE_URL` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è Google Cloud Run.

### –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

Keep-alive –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è, –µ—Å–ª–∏ `SERVICE_URL` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:

```
‚ö†Ô∏è SERVICE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - keep-alive –æ—Ç–∫–ª—é—á–µ–Ω (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### Keep-alive –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `SERVICE_URL` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ Cloud Run

### –û—à–∏–±–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç `/health` –¥–æ—Å—Ç—É–ø–µ–Ω
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤—É—é —Å–≤—è–∑–Ω–æ—Å—Ç—å
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω 30 —Å–µ–∫—É–Ω–¥)

### –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

1. –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–∏–Ω–≥–æ–≤ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –∫–æ–¥–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç)
2. –¢–∞–π–º–∞—É—Ç HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30 —Å–µ–∫—É–Ω–¥)

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

- **–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–∏–Ω–≥–æ–≤**: 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
- **–¢–∞–π–º–∞—É—Ç HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤**: 30 —Å–µ–∫—É–Ω–¥
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ HTTP-–∫–ª–∏–µ–Ω—Ç–∞**: httpx (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è)
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏